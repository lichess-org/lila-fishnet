name: deploy

on:
  workflow_dispatch:
    inputs:
      env:
        required: true
        type: choice
        options:
          - starr
  workflow_call:
    inputs:
      env:
        description: Target environment for deployment
        required: true
        type: string

jobs:

  stage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21
      - name: Setup sbt
        uses: sbt/setup-sbt@v1
      - run: sbt stage
      - uses: actions/upload-artifact@v4
        with:
          name: lila-fishnet-app
          path: app/target/universal/stage

  deploy-app:
    runs-on: ubuntu-latest
    needs: stage
    environment:
      name: ${{ inputs.env }}
    strategy:
      fail-fast: false
    concurrency:
      group: deploy-${{ inputs.env }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v5
        with:
          name: lila-fishnet-app
          path: stage

      - name: Configure SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          touch ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          echo "$SSH_KEY" > ~/.ssh/id_deploy
          echo "$SSH_HOST $SSH_HOST_KEY" > ~/.ssh/known_hosts
          cat >>~/.ssh/config <<END
          Host deploy-host
            HostName $SSH_HOST
            User $SSH_USER
            IdentityFile ~/.ssh/id_deploy
            StrictHostKeyChecking yes
          END
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST_KEY: ${{ secrets.SSH_HOST_KEY }}

      - name: Deploy via SSH
        run: |
          set -euo pipefail
          if [ ! -d stage/bin ]; then
            echo "ERROR: Expected staged artifact (stage/bin) not found. You skipped build jobs via workflow_dispatch."
            exit 1
          fi
          RSYNC_OPTIONS="--archive --no-o --no-g --force --delete --progress --compress --checksum --verbose --exclude RUNNING_PID --exclude '.git/'"
          include="stage/bin stage/lib"
          echo "Deploying lila-fishnet"
          rsync $RSYNC_OPTIONS $include deploy-host:/home/lila-fishnet
          echo "rsync complete"

          echo "Restart lila-fishnet"
          ssh deploy-host "chmod +x /home/lila-fishnet/bin/lila-fishnet && chown -R lila-fishnet:lila-fisnet /home/lila-fishnet && systemctl restart lila-fishnet"

          echo "Deploy complete"
